# https://traefik.io/blog/install-and-configure-traefik-with-helm/

- name: configure traefik dashboard dependencies (htpassword)
  ansible.builtin.shell: htpasswd -nb ansible password | openssl base64
  register: traefik_dashboard_password

# - name: "print hash"
#   debug:
#     msg: "hash is {{ traefik_dashboard_password.stdout }}"

- name: configure traefik dashboard (secret)
  # https://community.traefik.io/t/error-while-reading-basic-auth-middleware-failed-to-load-auth-credentials/3819
  # https://doc.traefik.io/traefik/v2.10/providers/kubernetes-crd/#allowcrossnamespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: traefik-dashboard-auth
        namespace: traefik
      type: Opaque
      data:
        users: "{{ traefik_dashboard_password.stdout }}" # "ansible:password"

- name: configure traefik dashboard (middleware)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.containo.us/v1alpha1
      kind: Middleware
      metadata:
        name: traefik-dashboard-basicauth
        namespace: traefik
      spec:
        headers:
          browserXssFilter: true
          contentTypeNosniff: true
          forceSTSHeader: true
          stsIncludeSubdomains: true
          stsPreload: true
          stsSeconds: 15552000
          customFrameOptionsValue: SAMEORIGIN
          customRequestHeaders:
            X-Forwarded-Proto: https
        basicAuth:
          secret: traefik-dashboard-auth

- name: configure traefik dashboard (ingress)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.containo.us/v1alpha1
      kind: IngressRoute
      metadata:
        name: traefik-dashboard-route
        namespace: traefik
        annotations: 
          kubernetes.io/ingress.class: traefik-external
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "PathPrefix(`/api`, `/dashboard`)" # Host(`andromeda`) # this needs to be set on PiHole, a work-around is setting this in /etc/hosts
            kind: Rule
            services:
              - name: api@internal
                kind: TraefikService
            middlewares:
              - name: traefik-dashboard-basicauth
